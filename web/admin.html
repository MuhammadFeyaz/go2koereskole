<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>go2k√∏reskole ‚Äì Admin</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <!-- NAV -->
  <header class="nav">
    <div class="container nav__inner">

      <div class="nav__toprow">
        <a class="brand" href="index.html">
          <span class="brand__dot"></span> go2k√∏reskole
        </a>

        <button class="nav__toggle" id="navToggle" type="button" aria-expanded="false" aria-controls="navMenu">
          ‚ò∞ <span data-i18n="navMenu">Menu</span>
        </button>
      </div>

      <nav class="menu" id="navMenu">
        <a data-i18n="navHome" href="index.html">Hjem</a>
        <a data-i18n="navBooking" href="booking.html">Booking</a>
        <a data-i18n="navPrices" href="priser.html">Priser</a>
        <a data-i18n="navContact" href="kontakt.html">Kontakt</a>
      </nav>

      <div class="nav__right">
        <a class="btn btn--primary" data-i18n="navBookNow" href="booking.html">Book nu</a>

        <button class="theme-toggle" id="themeToggle" type="button">
          <span id="themeIcon">üåô</span>
          <span id="themeText" data-i18n="themeDark">M√∏rk</span>
        </button>

        <button class="lang-toggle" id="langToggle" type="button">
          <span id="langText">DA</span>
        </button>

        <div id="navUser" style="display:flex; gap:12px; align-items:center;">
          <span id="navUserText" class="muted"></span>
          <a id="navLoginBtn" class="btn" data-i18n="navLogin" href="login.html">Login</a>
          <button id="navLogoutBtn" class="btn" data-i18n="navLogout" style="display:none;">Log ud</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="section" style="padding-top:24px;">
      <div class="container">
        <div class="section__head" style="margin-bottom:14px;">
          <h2 style="margin:0;">Admin</h2>
          <p class="muted" style="margin:0;">Se bookinger og godkend/afvis. Opret elever.</p>
        </div>

        <div class="booking-grid">
          <!-- Create student -->
          <div class="card">
            <h3 style="margin-top:0;">Opret elev</h3>

            <form id="createStudentForm">
              <label class="field">
                <span>Navn</span>
                <input id="stuName" required placeholder="Fx Ahmad Ali" />
              </label>

              <label class="field">
                <span>E-mail</span>
                <input id="stuEmail" type="email" required placeholder="fx elev@email.com" />
              </label>

              <label class="field">
                <span>Telefon</span>
                <input id="stuPhone" required placeholder="fx 12345678" />
              </label>

              <label class="field">
                <span>Midlertidigt kodeord</span>
                <input id="stuPass" required placeholder="fx Elev123!" />
              </label>

              <button class="btn btn--primary btn--full" type="submit">Opret elev</button>
              <div id="stuStatus" class="status" style="margin-top:12px;"></div>
            </form>

            <hr />
            <h3>Elever</h3>
            <div id="studentsList" class="muted">Indl√¶ser...</div>
          </div>

          <!-- Bookings list -->
          <div class="card">
            <h3 style="margin-top:0;">Bookinger</h3>
            <div id="adminBookings" class="muted">Indl√¶ser...</div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container footer__inner">
        <span>¬© go2k√∏reskole</span>
        <span class="muted" data-i18n="footerTag">K√∏reskole booking</span>
      </div>
    </footer>
  </main>

  <script>
    (async () => {
      const $ = (id) => document.getElementById(id);

      async function api(path, options = {}) {
        const res = await fetch(path, { credentials: "include", ...options });
        const data = await res.json().catch(() => ({}));
        return { res, data };
      }

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Guard: must be admin
      const me = await api("/api/auth/me");
      if (!me?.data?.user) {
        window.location.href = "/login.html";
        return;
      }
      if (me.data.user.role !== "admin") {
        window.location.href = "/index.html";
        return;
      }

      // Students
      async function loadStudents() {
        const el = $("studentsList");
        if (!el) return;

        const { res, data } = await api("/api/admin/students");
        if (!res.ok) {
          el.textContent = "Kunne ikke hente elever.";
          return;
        }

        const list = data.students || [];
        if (!list.length) {
          el.textContent = "Ingen elever endnu.";
          return;
        }

        el.innerHTML = `
          <div style="display:grid; gap:10px;">
            ${list.map(s => `
              <div class="card" style="padding:14px; box-shadow:none;">
                <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div><strong>${esc(s.name)}</strong></div>
                  <div class="muted">${esc(s.phone)}</div>
                </div>
                <div class="muted" style="margin-top:6px;">${esc(s.email)}</div>
              </div>
            `).join("")}
          </div>
        `;
      }

      // Bookings
      function badge(status) {
        const s = String(status || "PENDING").toUpperCase();
        if (s === "APPROVED") return "‚úÖ GODKENDT";
        if (s === "DENIED") return "‚ùå AFVIST";
        return "‚è≥ AFVENTER";
      }

      async function loadBookings() {
        const el = $("adminBookings");
        if (!el) return;

        const { res, data } = await api("/api/admin/bookings");
        if (!res.ok) {
          el.textContent = "Kunne ikke hente bookinger.";
          return;
        }

        const list = data.bookings || [];
        if (!list.length) {
          el.textContent = "Ingen bookinger endnu.";
          return;
        }

        el.innerHTML = `
          <div style="display:grid; gap:10px;">
            ${list.map(b => `
              <div class="card" style="padding:14px; box-shadow:none;">
                <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div>
                    <strong>${esc(b.fullName || b.email)}</strong>
                    <span class="muted">(${esc(b.studentEmail || b.email)})</span>
                  </div>
                  <div class="muted"><strong>${badge(b.status)}</strong></div>
                </div>

                <div class="muted" style="margin-top:6px;">
                  ${esc(b.lessonType || "K√∏relektion")} ‚Ä¢ ${esc(b.date)} kl. ${esc(b.startTime)} ‚Ä¢ ${esc(b.durationMin)} min
                </div>

                <div class="muted" style="margin-top:6px;">
                  ${esc(b.address)}
                </div>

                ${b.note ? `<div class="muted" style="margin-top:6px;">Note: ${esc(b.note)}</div>` : ""}

                <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
                  <button class="btn btn--primary" data-approve="${esc(b.id)}">Godkend</button>
                  <button class="btn" data-deny="${esc(b.id)}">Afvis</button>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        // Attach handlers
        el.querySelectorAll("[data-approve]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-approve");
            const { res, data } = await api(`/api/admin/bookings/${id}/approve`, { method: "POST" });
            if (!res.ok) {
              alert(data?.message || "Kunne ikke godkende.");
              return;
            }
            loadBookings();
          });
        });

        el.querySelectorAll("[data-deny]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-deny");
            const { res, data } = await api(`/api/admin/bookings/${id}/deny`, { method: "POST" });
            if (!res.ok) {
              alert(data?.message || "Kunne ikke afvise.");
              return;
            }
            loadBookings();
          });
        });
      }

      // Create student
      const form = $("createStudentForm");
      const statusEl = $("stuStatus");
      const setStatus = (txt, type="") => {
        if (!statusEl) return;
        statusEl.textContent = txt;
        statusEl.className = `status ${type}`.trim();
      };

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        setStatus("");

        const payload = {
          name: $("stuName").value.trim(),
          email: $("stuEmail").value.trim(),
          phone: $("stuPhone").value.trim(),
          password: $("stuPass").value
        };

        const { res, data } = await api("/api/admin/students", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          if (data?.error === "EMAIL_EXISTS") setStatus("E-mail findes allerede.", "error");
          else setStatus(data?.error || "Kunne ikke oprette elev.", "error");
          return;
        }

        setStatus("‚úÖ Elev oprettet!", "success");
        form.reset();
        loadStudents();
      });

      await loadStudents();
      await loadBookings();
      setInterval(loadBookings, 8000);
    })();
  </script>

  <script src="./app.js"></script>
</body>
</html>
